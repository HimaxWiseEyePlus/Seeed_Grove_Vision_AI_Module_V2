name: Check and Pull Upstream Updates
on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: '0 0 * * *' # Runs each day UTC midnight
  workflow_dispatch:

jobs:
  update-upstream:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Fetch upstream
      run: git fetch https://github.com/HimaxWiseEyePlus/Seeed_Grove_Vision_AI_Module_V2.git main:upstream/main

    - name: Check if merge is possible
      id: merge_check
      run: |
        if git merge-base --is-ancestor upstream/main main; then
          echo "merge_status=up_to_date" >> $GITHUB_OUTPUT
        elif git merge-tree $(git merge-base upstream/main main) main upstream/main | grep -q "^<<<<<<< "; then
          echo "merge_status=conflict" >> $GITHUB_OUTPUT
        else
          echo "merge_status=can_merge" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      if: steps.merge_check.outputs.merge_status == 'can_merge'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: Update from upstream repository
        title: Automated Update from Upstream
        body: |
          This is an automated pull request to update from the upstream repository.
          Please review the changes and merge if appropriate.
        branch: automated-upstream-update
        base: main
        labels: automated,upstream-update
        reviewers: |
          Tobyntobyn
          acutetech
          victor-wildlife          
        draft: false

    - name: Handle conflicts or up-to-date scenario
      if: steps.merge_check.outputs.merge_status != 'can_merge'
      run: |
        if [ "${{ steps.merge_check.outputs.merge_status }}" = "conflict" ]; then
          echo "Merge conflicts detected. Manual intervention required."
          exit 1
        else
          echo "Already up to date with upstream."
        fi
